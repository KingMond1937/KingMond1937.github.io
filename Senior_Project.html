<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Countdown Timer</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: white;
        }

        .timer-container {
            text-align: center;
        }

        input {
            width: 50px;
            text-align: center;
            font-size: 1.2rem;
        }

        #time-display {
            font-size: 2rem;
            margin: 20px 0;
        }

        .button-group button {
            font-size: 1.2rem;
            margin: 10px;
            padding: 10px 20px;
        }

        /*
        body.flash {
            background-color: red;
            transition: background-color 0.5s ease;
        }
        */

        #sensor-data {
            margin-top: 20px;
            font-size: 1.5rem;
            color: blue;
        }
    </style>
</head>
<body>
<div class="timer-container">
    <div>
        <label for="hours"></label><input id="hours" max="23" min="0" placeholder="HH" type="number">
        <label for="minutes"></label><input id="minutes" max="59" min="0" placeholder="MM" type="number">
        <label for="seconds"></label><input id="seconds" max="59" min="0" placeholder="SS" type="number">
    </div>
    <div id="time-display">00:00:00</div>
    <div class="button-group">
        <button id="start-btn">Start</button>
        <button id="stop-btn">Stop</button>
        <button id="reset-btn">Reset</button>
    </div>

    <!-- Add a div for displaying sensor data -->
    <div id="sensor-data">Waiting for sensor data...</div>
</div>

<script>
    let timer;
    let flashInterval;
    let totalSeconds = 0;
    let running = false;

    const hoursInput = document.getElementById('hours');
    const minutesInput = document.getElementById('minutes');
    const secondsInput = document.getElementById('seconds');
    const timeDisplay = document.getElementById('time-display');
    const startButton = document.getElementById('start-btn');
    const stopButton = document.getElementById('stop-btn');
    const resetButton = document.getElementById('reset-btn');

    function updateDisplay() {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        timeDisplay.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function startTimer() {
        if (!running) {
            const hours = parseInt(hoursInput.value) || 0;
            const minutes = parseInt(minutesInput.value) || 0;
            const seconds = parseInt(secondsInput.value) || 0;
            totalSeconds = hours * 3600 + minutes * 60 + seconds;

            if (totalSeconds > 0) {
                updateDisplay(); // Immediately update display with the correct initial time
                running = true;

                timer = setInterval(() => {
                    if (totalSeconds > 0) {
                        totalSeconds--;
                        updateDisplay(); // Update display after each decrement
                    } else {
                        clearInterval(timer);
                        flashRed(); // Start flashing when time hits zero
                    }
                }, 1000); // Decrement every second
            }
        }
    }

    function stopTimer() {
        running = false;
        clearInterval(timer); // Stop the countdown timer
        clearInterval(flashInterval); // Stop flashing if the timer is stopped
        document.body.classList.remove('flash'); // Ensure the flashing stops immediately
    }

    function resetTimer() {
        running = false;
        clearInterval(timer); // Stop the countdown timer
        clearInterval(flashInterval); // Stop flashing if the reset button is pressed
        totalSeconds = 0;
        updateDisplay(); // Reset the display to 00:00:00
        document.body.classList.remove('flash'); // Ensure the flashing stops and the background is reset
    }

    function flashRed() {
        // Clear any existing flash interval to prevent multiple intervals from running simultaneously
        clearInterval(flashInterval);

        // Set up the flashing effect to continue indefinitely
        flashInterval = setInterval(() => {
            document.body.classList.toggle('flash');
        }, 500); // Toggle every 500 milliseconds for a slower flash effect
    }

    startButton.addEventListener('click', startTimer);
    stopButton.addEventListener('click', stopTimer);
    resetButton.addEventListener('click', resetTimer);

    updateDisplay();

    // WebSocket connection to ESP32 WebSocket server
    const webSocket = new WebSocket('ws://YOUR_ESP32_IP_ADDRESS:81');

    // Find the element where data will be displayed
    const dataDiv = document.getElementById('sensor-data');

    // Event handler for when a message is received from the WebSocket server
    webSocket.onmessage = function (event) {
        // Update the webpage with the incoming sensor data
        dataDiv.textContent = 'Sensor Data: ' + event.data;
    };

    // ERROR HANDLING
    // Event handler for WebSocket errors
    webSocket.onerror = function (error) {
        console.error('WebSocket Error: ', error);
    };

    // Optionally, handle the connection opening event
    webSocket.onopen = function () {
        console.log('WebSocket connection established');
    };

    // Optionally, handle the connection closing event
    webSocket.onclose = function () {
        console.log('WebSocket connection closed');
    };
</script>
</body>
</html>
